version: 1
steps:
  - name: Ensure Go 1.24.11 is installed
    run: |
      set -euxo pipefail
      GO_VERSION=1.24.11
      if ! command -v go >/dev/null 2>&1 || [ "$(go version | awk '{print $3}')" != "go${GO_VERSION}" ]; then
        sudo rm -rf /usr/local/go
        curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -o /tmp/go.tar.gz
        sudo tar -C /usr/local -xzf /tmp/go.tar.gz
        rm /tmp/go.tar.gz
      fi
      /usr/local/go/bin/go version
  - name: Install goimports
    run: |
      set -euxo pipefail
      export PATH="/usr/local/go/bin:${PATH}"
      GOBIN=/usr/local/bin /usr/local/go/bin/go install golang.org/x/tools/cmd/goimports@latest
      goimports --help >/dev/null
  - name: Install golangci-lint
    run: |
      set -euxo pipefail
      export PATH="/usr/local/go/bin:${PATH}"
      GOLANGCI_LINT_VERSION="v1.61.0"
      GOLANGCI_LINT_ARCHIVE="/tmp/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-amd64.tar.gz"
      curl -sSfL "https://github.com/golangci/golangci-lint/releases/download/${GOLANGCI_LINT_VERSION}/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-amd64.tar.gz" -o "${GOLANGCI_LINT_ARCHIVE}"
      tar -C /tmp -xzf "${GOLANGCI_LINT_ARCHIVE}"
      sudo mv "/tmp/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-amd64/golangci-lint" /usr/local/bin/
      rm -rf "/tmp/golangci-lint-${GOLANGCI_LINT_VERSION#v}-linux-amd64" "${GOLANGCI_LINT_ARCHIVE}"
      golangci-lint version
  - name: Install latest Docker Engine
    run: |
      set -euxo pipefail
      sudo apt-get update
      sudo apt-get install -y ca-certificates curl gnupg
      sudo install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      sudo chmod a+r /etc/apt/keyrings/docker.gpg
      sudo tee /etc/apt/sources.list.d/docker.list >/dev/null <<EOF
deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable
EOF
      sudo apt-get update
      sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      # Adding the current user to the docker group enables Docker commands without sudo; adjust if stricter isolation is required.
      sudo usermod -aG docker "$USER"
      if command -v systemctl >/dev/null 2>&1; then
        sudo systemctl enable docker --now
      elif command -v service >/dev/null 2>&1; then
        sudo service docker start
      fi
      docker --version
      docker compose version
